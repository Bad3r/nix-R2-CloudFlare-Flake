name: Deploy R2-Explorer

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
    paths:
      - "r2-explorer/**"
      - ".github/workflows/r2-explorer-deploy.yml"
      - "scripts/ci/render-r2-explorer-wrangler-config.sh"
      - "scripts/ci/sync-r2-upload-cors.sh"
      - "scripts/ci/sync-r2-web-csp.sh"
      - "scripts/ci/check-r2-web-security.sh"
      - "scripts/ci/worker-share-smoke.sh"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (must be main for production)"
        required: true
        default: "main"

permissions:
  contents: read
  deployments: write

jobs:
  deploy-preview:
    name: Deploy preview
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !github.event.pull_request.draft &&
      contains(github.event.pull_request.labels.*.name, 'preview-deploy-approved') &&
      (
        github.event.pull_request.author_association == 'OWNER' ||
        github.event.pull_request.author_association == 'MEMBER' ||
        github.event.pull_request.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    environment: preview
    concurrency:
      group: r2-explorer-preview-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    env:
      R2E_FILES_BUCKET: ${{ vars.R2E_FILES_BUCKET }}
      R2E_FILES_BUCKET_PREVIEW: ${{ vars.R2E_FILES_BUCKET_PREVIEW }}
      R2E_SHARES_KV_ID: ${{ vars.R2E_SHARES_KV_ID }}
      R2E_SHARES_KV_ID_PREVIEW: ${{ vars.R2E_SHARES_KV_ID_PREVIEW }}
      R2E_KEYS_KV_ID: ${{ vars.R2E_KEYS_KV_ID }}
      R2E_KEYS_KV_ID_PREVIEW: ${{ vars.R2E_KEYS_KV_ID_PREVIEW }}
      R2E_BUCKET_MAP: ${{ vars.R2E_BUCKET_MAP }}
      R2E_ACCESS_TEAM_DOMAIN: ${{ vars.R2E_ACCESS_TEAM_DOMAIN }}
      R2E_ACCESS_TEAM_DOMAIN_PREVIEW: ${{ vars.R2E_ACCESS_TEAM_DOMAIN_PREVIEW }}
      R2E_ACCESS_AUD: ${{ vars.R2E_ACCESS_AUD }}
      R2E_ACCESS_AUD_PREVIEW: ${{ vars.R2E_ACCESS_AUD_PREVIEW }}
      R2E_UPLOAD_MAX_FILE_BYTES: ${{ vars.R2E_UPLOAD_MAX_FILE_BYTES }}
      R2E_UPLOAD_MAX_FILE_BYTES_PREVIEW: ${{ vars.R2E_UPLOAD_MAX_FILE_BYTES_PREVIEW }}
      R2E_UPLOAD_MAX_PARTS: ${{ vars.R2E_UPLOAD_MAX_PARTS }}
      R2E_UPLOAD_MAX_PARTS_PREVIEW: ${{ vars.R2E_UPLOAD_MAX_PARTS_PREVIEW }}
      R2E_UPLOAD_MAX_CONCURRENT_PER_USER: ${{ vars.R2E_UPLOAD_MAX_CONCURRENT_PER_USER }}
      R2E_UPLOAD_MAX_CONCURRENT_PER_USER_PREVIEW: ${{ vars.R2E_UPLOAD_MAX_CONCURRENT_PER_USER_PREVIEW }}
      R2E_UPLOAD_SESSION_TTL_SEC: ${{ vars.R2E_UPLOAD_SESSION_TTL_SEC }}
      R2E_UPLOAD_SESSION_TTL_SEC_PREVIEW: ${{ vars.R2E_UPLOAD_SESSION_TTL_SEC_PREVIEW }}
      R2E_UPLOAD_SIGN_TTL_SEC: ${{ vars.R2E_UPLOAD_SIGN_TTL_SEC }}
      R2E_UPLOAD_SIGN_TTL_SEC_PREVIEW: ${{ vars.R2E_UPLOAD_SIGN_TTL_SEC_PREVIEW }}
      R2E_UPLOAD_PART_SIZE_BYTES: ${{ vars.R2E_UPLOAD_PART_SIZE_BYTES }}
      R2E_UPLOAD_PART_SIZE_BYTES_PREVIEW: ${{ vars.R2E_UPLOAD_PART_SIZE_BYTES_PREVIEW }}
      R2E_UPLOAD_ALLOWED_MIME: ${{ vars.R2E_UPLOAD_ALLOWED_MIME }}
      R2E_UPLOAD_ALLOWED_MIME_PREVIEW: ${{ vars.R2E_UPLOAD_ALLOWED_MIME_PREVIEW }}
      R2E_UPLOAD_BLOCKED_MIME: ${{ vars.R2E_UPLOAD_BLOCKED_MIME }}
      R2E_UPLOAD_BLOCKED_MIME_PREVIEW: ${{ vars.R2E_UPLOAD_BLOCKED_MIME_PREVIEW }}
      R2E_UPLOAD_ALLOWED_EXT: ${{ vars.R2E_UPLOAD_ALLOWED_EXT }}
      R2E_UPLOAD_ALLOWED_EXT_PREVIEW: ${{ vars.R2E_UPLOAD_ALLOWED_EXT_PREVIEW }}
      R2E_UPLOAD_BLOCKED_EXT: ${{ vars.R2E_UPLOAD_BLOCKED_EXT }}
      R2E_UPLOAD_BLOCKED_EXT_PREVIEW: ${{ vars.R2E_UPLOAD_BLOCKED_EXT_PREVIEW }}
      R2E_UPLOAD_PREFIX_ALLOWLIST: ${{ vars.R2E_UPLOAD_PREFIX_ALLOWLIST }}
      R2E_UPLOAD_PREFIX_ALLOWLIST_PREVIEW: ${{ vars.R2E_UPLOAD_PREFIX_ALLOWLIST_PREVIEW }}
      R2E_UPLOAD_ALLOWED_ORIGINS: ${{ vars.R2E_UPLOAD_ALLOWED_ORIGINS }}
      R2E_UPLOAD_ALLOWED_ORIGINS_PREVIEW: ${{ vars.R2E_UPLOAD_ALLOWED_ORIGINS_PREVIEW }}
      R2E_UPLOAD_S3_BUCKET: ${{ vars.R2E_UPLOAD_S3_BUCKET }}
      R2E_UPLOAD_S3_BUCKET_PREVIEW: ${{ vars.R2E_UPLOAD_S3_BUCKET_PREVIEW }}
      R2E_CF_ZONE_NAME: ${{ vars.R2E_CF_ZONE_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Reject unexpected preview base URL
        env:
          R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
        run: |
          set -euo pipefail
          expected_base_url="https://preview.files.unsigned.sh"
          if [[ "${R2E_SMOKE_BASE_URL}" != "${expected_base_url}" ]]; then
            echo "Preview smoke/deploy base URL drift detected." >&2
            echo "Expected '${expected_base_url}' but got '${R2E_SMOKE_BASE_URL}'." >&2
            exit 1
          fi

      - name: Render Wrangler config
        run: ./scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: r2-explorer/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        working-directory: r2-explorer
        run: pnpm run check

      - name: Test
        working-directory: r2-explorer
        run: pnpm test

      - name: Build web bundle
        working-directory: r2-explorer
        run: pnpm run build:web

      - name: Sync runtime upload signing secrets (preview)
        working-directory: r2-explorer
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail
          printf '%s' "${CLOUDFLARE_ACCOUNT_ID}" | pnpm exec wrangler secret put CLOUDFLARE_ACCOUNT_ID --config wrangler.ci.toml --env preview
          printf '%s' "${S3_ACCESS_KEY_ID}" | pnpm exec wrangler secret put S3_ACCESS_KEY_ID --config wrangler.ci.toml --env preview
          printf '%s' "${S3_SECRET_ACCESS_KEY}" | pnpm exec wrangler secret put S3_SECRET_ACCESS_KEY --config wrangler.ci.toml --env preview

      - name: Sync upload bucket CORS (preview)
        working-directory: r2-explorer
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
        run: |
          set -euo pipefail
          ../scripts/ci/sync-r2-upload-cors.sh \
            "${R2E_UPLOAD_S3_BUCKET_PREVIEW:-${R2E_FILES_BUCKET_PREVIEW}}" \
            "${R2E_UPLOAD_ALLOWED_ORIGINS_PREVIEW:-${R2E_UPLOAD_ALLOWED_ORIGINS}}" \
            "${R2E_SMOKE_BASE_URL}"

      - name: Sync web CSP transform rule (preview, conditional)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
        run: |
          set -euo pipefail

          zone_name="$(printf '%s' "${R2E_CF_ZONE_NAME:-}" | tr '[:upper:]' '[:lower:]')"
          preview_host="$(
            printf '%s' "${R2E_SMOKE_BASE_URL:-}" |
              sed -E 's#^[a-zA-Z][a-zA-Z0-9+.-]*://##; s#/.*$##; s#:[0-9]+$##' |
              tr '[:upper:]' '[:lower:]'
          )"

          if [[ -z "${zone_name}" ]]; then
            echo "::notice::Skipping preview CSP sync: R2E_CF_ZONE_NAME is empty in GitHub preview environment vars."
            exit 0
          fi

          if [[ -z "${preview_host}" ]]; then
            echo "::notice::Skipping preview CSP sync: preview host could not be derived from R2E_SMOKE_BASE_URL."
            exit 0
          fi

          if [[ "${preview_host}" == "${zone_name}" || "${preview_host}" == *".${zone_name}" ]]; then
            echo "Preview host '${preview_host}' is in zone '${zone_name}'; syncing web CSP rule."
            ./scripts/ci/sync-r2-web-csp.sh \
              "${preview_host}" \
              "r2-explorer/web/config/csp.analytics.production.txt"
            exit 0
          fi

          echo "::notice::Skipping preview CSP sync: preview host '${preview_host}' is outside configured zone '${zone_name}'."

      - name: Deploy preview
        working-directory: r2-explorer
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
        run: pnpm exec wrangler deploy --config wrangler.ci.toml --env preview

      - name: Deploy preview web
        working-directory: r2-explorer
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -euo pipefail
          cp web/.assetsignore web/dist/.assetsignore
          pnpm exec wrangler deploy --config web/wrangler.toml --env preview

  smoke-preview:
    name: Smoke preview
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !github.event.pull_request.draft &&
      contains(github.event.pull_request.labels.*.name, 'preview-deploy-approved') &&
      (
        github.event.pull_request.author_association == 'OWNER' ||
        github.event.pull_request.author_association == 'MEMBER' ||
        github.event.pull_request.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    needs: [deploy-preview]
    environment: preview
    env:
      R2E_SMOKE_RETRIES: "1"
      R2E_SMOKE_RETRY_DELAY_SEC: "2"
      R2E_CF_ZONE_NAME: ${{ vars.R2E_CF_ZONE_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = true
            extra-substituters = https://nix-r2-cloudflare-flake.cachix.org https://wrangler.cachix.org
            extra-trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-r2-cloudflare-flake.cachix.org-1:pmYucG85iBm6Y+8TxNwqU5j/lmY1UBReZxIXslMFntw= wrangler.cachix.org-1:N/FIcG2qBQcolSpklb2IMDbsfjZKWg+ctxx0mSMXdSs=

      - name: Build r2 CLI
        run: nix --accept-flake-config build .#r2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies for live tests
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Verify preview web CSP and analytics markers (conditional)
        env:
          R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
          R2E_SMOKE_ACCESS_CLIENT_ID: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_ID }}
          R2E_SMOKE_ACCESS_CLIENT_SECRET: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_SECRET }}
        run: |
          set -euo pipefail

          zone_name="$(printf '%s' "${R2E_CF_ZONE_NAME:-}" | tr '[:upper:]' '[:lower:]')"
          preview_host="$(
            printf '%s' "${R2E_SMOKE_BASE_URL:-}" |
              sed -E 's#^[a-zA-Z][a-zA-Z0-9+.-]*://##; s#/.*$##; s#:[0-9]+$##' |
              tr '[:upper:]' '[:lower:]'
          )"

          if [[ -z "${zone_name}" ]]; then
            echo "::notice::Skipping preview CSP/analytics verification: R2E_CF_ZONE_NAME is empty in GitHub preview environment vars."
            exit 0
          fi

          if [[ -z "${preview_host}" ]]; then
            echo "::notice::Skipping preview CSP/analytics verification: preview host could not be derived from R2E_SMOKE_BASE_URL."
            exit 0
          fi

          if [[ "${preview_host}" == "${zone_name}" || "${preview_host}" == *".${zone_name}" ]]; then
            echo "Preview host '${preview_host}' is in zone '${zone_name}'; running web CSP/analytics verification."
            ./scripts/ci/check-r2-web-security.sh \
              "${R2E_SMOKE_BASE_URL}" \
              "r2-explorer/web/config/csp.analytics.production.txt"
            exit 0
          fi

          echo "::notice::Skipping preview CSP/analytics verification: preview host '${preview_host}' is outside configured zone '${zone_name}'."

      - name: Run Worker smoke checks
        env:
          R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
          R2E_SMOKE_ADMIN_KID: ${{ secrets.R2E_SMOKE_ADMIN_KID }}
          R2E_SMOKE_ADMIN_SECRET: ${{ secrets.R2E_SMOKE_ADMIN_SECRET }}
          R2E_SMOKE_BUCKET: ${{ secrets.R2E_SMOKE_BUCKET }}
          R2E_SMOKE_KEY: ${{ secrets.R2E_SMOKE_KEY }}
          R2E_SMOKE_ACCESS_CLIENT_ID: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_ID }}
          R2E_SMOKE_ACCESS_CLIENT_SECRET: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_SECRET }}
          R2E_SMOKE_R2_BIN: ./result/bin/r2
        run: |
          set -euo pipefail
          ./scripts/ci/worker-share-smoke.sh 2>&1 | tee smoke-preview.log

      - name: Run live integration tests (no mocks)
        working-directory: r2-explorer
        env:
          R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
          R2E_SMOKE_ADMIN_KID: ${{ secrets.R2E_SMOKE_ADMIN_KID }}
          R2E_SMOKE_ADMIN_SECRET: ${{ secrets.R2E_SMOKE_ADMIN_SECRET }}
          R2E_SMOKE_BUCKET: ${{ secrets.R2E_SMOKE_BUCKET }}
          R2E_SMOKE_KEY: ${{ secrets.R2E_SMOKE_KEY }}
          R2E_SMOKE_ACCESS_CLIENT_ID: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_ID }}
          R2E_SMOKE_ACCESS_CLIENT_SECRET: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_SECRET }}
          R2E_SMOKE_R2_BIN: ../result/bin/r2
        run: |
          set -euo pipefail
          pnpm run test:live 2>&1 | tee -a ../smoke-preview.log

      - name: Upload smoke logs (preview)
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: smoke-preview-logs
          path: smoke-preview.log
          if-no-files-found: ignore

  rollback-guidance-preview:
    name: Rollback guidance (preview)
    if: failure() && needs.smoke-preview.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy-preview, smoke-preview]
    steps:
      - name: Resolve rollback target
        id: rollback_target
        env:
          GH_TOKEN: ${{ github.token }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          set -euo pipefail

          deployments_json="$(gh api "repos/${GITHUB_REPOSITORY}/deployments?environment=preview&per_page=50")"
          candidate="$(
            printf '%s' "${deployments_json}" |
              jq -r --arg current "${GITHUB_SHA}" --arg ref "${GITHUB_HEAD_REF}" \
                '.[] | select(.sha != $current and .ref == $ref) | .sha' |
              head -n1
          )"

          if [[ -z "${candidate}" ]]; then
            candidate="${PR_BASE_SHA}"
          fi
          if [[ -z "${candidate}" ]]; then
            candidate="<last-known-good-ref>"
          fi

          echo "sha=${candidate}" >> "${GITHUB_OUTPUT}"

      - name: Publish rollback guidance
        run: |
          set -euo pipefail

          rollback_sha="${{ steps.rollback_target.outputs.sha }}"
          runbook_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_SHA}/docs/operators/rollback-worker-share.md"
          rollback_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${rollback_sha}"
          {
            echo "## Preview smoke checks failed"
            echo
            echo "Follow the Worker rollback runbook immediately:"
            echo "- ${runbook_url}"
            echo "- Candidate rollback SHA: \`${rollback_sha}\`"
            echo "- Candidate rollback tree: ${rollback_url}"
            echo "- Smoke logs artifact: \`smoke-preview-logs\`"
            echo
            echo "Required operator actions:"
            echo "1. Identify the last known-good Worker revision and matching env snapshot."
            echo "2. Redeploy the rollback target and reapply Access policy split."
            echo "3. Re-run share lifecycle and API protection checks."
            echo
            echo "Command checklist:"
            echo '```bash'
            echo 'git fetch origin'
            echo "git checkout ${rollback_sha}"
            echo './scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml'
            echo 'cd r2-explorer'
            echo 'pnpm install --frozen-lockfile'
            echo 'pnpm exec wrangler deploy --config wrangler.ci.toml --env preview'
            echo '```'
          } >> "${GITHUB_STEP_SUMMARY}"

  deploy-production:
    name: Deploy production
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: r2-explorer-production
      cancel-in-progress: false
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
      S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
      R2E_FILES_BUCKET: ${{ vars.R2E_FILES_BUCKET }}
      R2E_FILES_BUCKET_PREVIEW: ${{ vars.R2E_FILES_BUCKET_PREVIEW }}
      R2E_SHARES_KV_ID: ${{ vars.R2E_SHARES_KV_ID }}
      R2E_SHARES_KV_ID_PREVIEW: ${{ vars.R2E_SHARES_KV_ID_PREVIEW }}
      R2E_KEYS_KV_ID: ${{ vars.R2E_KEYS_KV_ID }}
      R2E_KEYS_KV_ID_PREVIEW: ${{ vars.R2E_KEYS_KV_ID_PREVIEW }}
      R2E_BUCKET_MAP: ${{ vars.R2E_BUCKET_MAP }}
      R2E_ACCESS_TEAM_DOMAIN: ${{ vars.R2E_ACCESS_TEAM_DOMAIN }}
      R2E_ACCESS_TEAM_DOMAIN_PREVIEW: ${{ vars.R2E_ACCESS_TEAM_DOMAIN_PREVIEW }}
      R2E_ACCESS_AUD: ${{ vars.R2E_ACCESS_AUD }}
      R2E_ACCESS_AUD_PREVIEW: ${{ vars.R2E_ACCESS_AUD_PREVIEW }}
      R2E_UPLOAD_MAX_FILE_BYTES: ${{ vars.R2E_UPLOAD_MAX_FILE_BYTES }}
      R2E_UPLOAD_MAX_FILE_BYTES_PREVIEW: ${{ vars.R2E_UPLOAD_MAX_FILE_BYTES_PREVIEW }}
      R2E_UPLOAD_MAX_PARTS: ${{ vars.R2E_UPLOAD_MAX_PARTS }}
      R2E_UPLOAD_MAX_PARTS_PREVIEW: ${{ vars.R2E_UPLOAD_MAX_PARTS_PREVIEW }}
      R2E_UPLOAD_MAX_CONCURRENT_PER_USER: ${{ vars.R2E_UPLOAD_MAX_CONCURRENT_PER_USER }}
      R2E_UPLOAD_MAX_CONCURRENT_PER_USER_PREVIEW: ${{ vars.R2E_UPLOAD_MAX_CONCURRENT_PER_USER_PREVIEW }}
      R2E_UPLOAD_SESSION_TTL_SEC: ${{ vars.R2E_UPLOAD_SESSION_TTL_SEC }}
      R2E_UPLOAD_SESSION_TTL_SEC_PREVIEW: ${{ vars.R2E_UPLOAD_SESSION_TTL_SEC_PREVIEW }}
      R2E_UPLOAD_SIGN_TTL_SEC: ${{ vars.R2E_UPLOAD_SIGN_TTL_SEC }}
      R2E_UPLOAD_SIGN_TTL_SEC_PREVIEW: ${{ vars.R2E_UPLOAD_SIGN_TTL_SEC_PREVIEW }}
      R2E_UPLOAD_PART_SIZE_BYTES: ${{ vars.R2E_UPLOAD_PART_SIZE_BYTES }}
      R2E_UPLOAD_PART_SIZE_BYTES_PREVIEW: ${{ vars.R2E_UPLOAD_PART_SIZE_BYTES_PREVIEW }}
      R2E_UPLOAD_ALLOWED_MIME: ${{ vars.R2E_UPLOAD_ALLOWED_MIME }}
      R2E_UPLOAD_ALLOWED_MIME_PREVIEW: ${{ vars.R2E_UPLOAD_ALLOWED_MIME_PREVIEW }}
      R2E_UPLOAD_BLOCKED_MIME: ${{ vars.R2E_UPLOAD_BLOCKED_MIME }}
      R2E_UPLOAD_BLOCKED_MIME_PREVIEW: ${{ vars.R2E_UPLOAD_BLOCKED_MIME_PREVIEW }}
      R2E_UPLOAD_ALLOWED_EXT: ${{ vars.R2E_UPLOAD_ALLOWED_EXT }}
      R2E_UPLOAD_ALLOWED_EXT_PREVIEW: ${{ vars.R2E_UPLOAD_ALLOWED_EXT_PREVIEW }}
      R2E_UPLOAD_BLOCKED_EXT: ${{ vars.R2E_UPLOAD_BLOCKED_EXT }}
      R2E_UPLOAD_BLOCKED_EXT_PREVIEW: ${{ vars.R2E_UPLOAD_BLOCKED_EXT_PREVIEW }}
      R2E_UPLOAD_PREFIX_ALLOWLIST: ${{ vars.R2E_UPLOAD_PREFIX_ALLOWLIST }}
      R2E_UPLOAD_PREFIX_ALLOWLIST_PREVIEW: ${{ vars.R2E_UPLOAD_PREFIX_ALLOWLIST_PREVIEW }}
      R2E_UPLOAD_ALLOWED_ORIGINS: ${{ vars.R2E_UPLOAD_ALLOWED_ORIGINS }}
      R2E_UPLOAD_ALLOWED_ORIGINS_PREVIEW: ${{ vars.R2E_UPLOAD_ALLOWED_ORIGINS_PREVIEW }}
      R2E_UPLOAD_S3_BUCKET: ${{ vars.R2E_UPLOAD_S3_BUCKET }}
      R2E_UPLOAD_S3_BUCKET_PREVIEW: ${{ vars.R2E_UPLOAD_S3_BUCKET_PREVIEW }}
      R2E_CF_ZONE_NAME: ${{ vars.R2E_CF_ZONE_NAME }}
    steps:
      - name: Reject non-main production deploy ref
        run: |
          if [[ "${{ github.event.inputs.ref }}" != "main" ]]; then
            echo "Production deploys require ref=main." >&2
            echo "Got '${{ github.event.inputs.ref }}'." >&2
            exit 1
          fi

      - name: Require production zone name variable
        run: |
          set -euo pipefail
          if [[ -z "${R2E_CF_ZONE_NAME:-}" ]]; then
            echo "R2E_CF_ZONE_NAME is required for production deploys." >&2
            echo "Set vars.R2E_CF_ZONE_NAME in the GitHub production environment." >&2
            exit 1
          fi

      - name: Reject unexpected production base URL
        env:
          R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
        run: |
          set -euo pipefail
          expected_base_url="https://files.unsigned.sh"
          if [[ "${R2E_SMOKE_BASE_URL}" != "${expected_base_url}" ]]; then
            echo "Production smoke/deploy base URL drift detected." >&2
            echo "Expected '${expected_base_url}' but got '${R2E_SMOKE_BASE_URL}'." >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Render Wrangler config
        run: ./scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: r2-explorer/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        working-directory: r2-explorer
        run: pnpm run check

      - name: Test
        working-directory: r2-explorer
        run: pnpm test

      - name: Build web bundle
        working-directory: r2-explorer
        run: pnpm run build:web

      - name: Sync web CSP transform rule (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/ci/sync-r2-web-csp.sh \
            "files.unsigned.sh" \
            "r2-explorer/web/config/csp.analytics.production.txt"

      - name: Sync runtime upload signing secrets (production)
        working-directory: r2-explorer
        run: |
          set -euo pipefail
          printf '%s' "${CLOUDFLARE_ACCOUNT_ID}" | pnpm exec wrangler secret put CLOUDFLARE_ACCOUNT_ID --config wrangler.ci.toml
          printf '%s' "${S3_ACCESS_KEY_ID}" | pnpm exec wrangler secret put S3_ACCESS_KEY_ID --config wrangler.ci.toml
          printf '%s' "${S3_SECRET_ACCESS_KEY}" | pnpm exec wrangler secret put S3_SECRET_ACCESS_KEY --config wrangler.ci.toml

      - name: Sync upload bucket CORS (production)
        working-directory: r2-explorer
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -euo pipefail
          ../scripts/ci/sync-r2-upload-cors.sh \
            "${R2E_UPLOAD_S3_BUCKET:-${R2E_FILES_BUCKET}}" \
            "${R2E_UPLOAD_ALLOWED_ORIGINS}" \
            "https://files.unsigned.sh"

      - name: Deploy production
        working-directory: r2-explorer
        run: pnpm exec wrangler deploy --config wrangler.ci.toml --env ""

      - name: Deploy production web
        working-directory: r2-explorer
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -euo pipefail
          cp web/.assetsignore web/dist/.assetsignore
          pnpm exec wrangler deploy --config web/wrangler.toml

  smoke-production:
    name: Smoke production
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [deploy-production]
    environment: production
    env:
      R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
      R2E_SMOKE_ADMIN_KID: ${{ secrets.R2E_SMOKE_ADMIN_KID }}
      R2E_SMOKE_ADMIN_SECRET: ${{ secrets.R2E_SMOKE_ADMIN_SECRET }}
      R2E_SMOKE_BUCKET: ${{ secrets.R2E_SMOKE_BUCKET }}
      R2E_SMOKE_KEY: ${{ secrets.R2E_SMOKE_KEY }}
      R2E_SMOKE_ACCESS_CLIENT_ID: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_ID }}
      R2E_SMOKE_ACCESS_CLIENT_SECRET: ${{ secrets.R2E_SMOKE_ACCESS_CLIENT_SECRET }}
      R2E_SMOKE_RETRIES: "2"
      R2E_SMOKE_RETRY_DELAY_SEC: "3"
      R2E_CF_ZONE_NAME: ${{ vars.R2E_CF_ZONE_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = true
            extra-substituters = https://nix-r2-cloudflare-flake.cachix.org https://wrangler.cachix.org
            extra-trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-r2-cloudflare-flake.cachix.org-1:pmYucG85iBm6Y+8TxNwqU5j/lmY1UBReZxIXslMFntw= wrangler.cachix.org-1:N/FIcG2qBQcolSpklb2IMDbsfjZKWg+ctxx0mSMXdSs=

      - name: Build r2 CLI
        run: nix --accept-flake-config build .#r2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies for live tests
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Verify web CSP and analytics markers
        run: |
          set -euo pipefail
          ./scripts/ci/check-r2-web-security.sh \
            "${R2E_SMOKE_BASE_URL}" \
            "r2-explorer/web/config/csp.analytics.production.txt"

      - name: Run Worker smoke checks
        env:
          R2E_SMOKE_R2_BIN: ./result/bin/r2
        run: |
          set -euo pipefail
          ./scripts/ci/worker-share-smoke.sh 2>&1 | tee smoke-production.log

      - name: Run live integration tests (no mocks)
        working-directory: r2-explorer
        env:
          R2E_SMOKE_R2_BIN: ../result/bin/r2
        run: |
          set -euo pipefail
          pnpm run test:live 2>&1 | tee -a ../smoke-production.log

      - name: Upload smoke logs (production)
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: smoke-production-logs
          path: smoke-production.log
          if-no-files-found: ignore

  rollback-guidance-production:
    name: Rollback guidance (production)
    if: failure() && needs.smoke-production.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy-production, smoke-production]
    steps:
      - name: Resolve rollback target
        id: rollback_target
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          deployments_json="$(gh api "repos/${GITHUB_REPOSITORY}/deployments?environment=production&per_page=50")"
          candidate="$(
            printf '%s' "${deployments_json}" |
              jq -r --arg current "${GITHUB_SHA}" \
                '.[] | select(.sha != $current) | .sha' |
              head -n1
          )"

          if [[ -z "${candidate}" ]]; then
            candidate="<last-known-good-ref>"
          fi

          echo "sha=${candidate}" >> "${GITHUB_OUTPUT}"

      - name: Publish rollback guidance
        run: |
          set -euo pipefail

          rollback_sha="${{ steps.rollback_target.outputs.sha }}"
          runbook_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_SHA}/docs/operators/rollback-worker-share.md"
          rollback_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${rollback_sha}"
          {
            echo "## Production smoke checks failed"
            echo
            echo "Immediate rollback path:"
            echo "- ${runbook_url}"
            echo "- Candidate rollback SHA: \`${rollback_sha}\`"
            echo "- Candidate rollback tree: ${rollback_url}"
            echo "- Smoke logs artifact: \`smoke-production-logs\`"
            echo
            echo "Required operator actions:"
            echo "1. Roll back to the last known-good Worker revision."
            echo "2. Restore matching environment variables and Access policy split."
            echo "3. Verify /share token behavior and /api Access protection before leaving incident mode."
            echo
            echo "Command checklist:"
            echo '```bash'
            echo 'git fetch origin'
            echo "git checkout ${rollback_sha}"
            echo './scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml'
            echo 'cd r2-explorer'
            echo 'pnpm install --frozen-lockfile'
            echo 'pnpm exec wrangler deploy --config wrangler.ci.toml --env ""'
            echo '```'
          } >> "${GITHUB_STEP_SUMMARY}"
