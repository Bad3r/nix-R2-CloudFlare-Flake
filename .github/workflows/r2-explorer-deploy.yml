name: Deploy R2-Explorer

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "r2-explorer/**"
      - ".github/workflows/r2-explorer-deploy.yml"
      - "scripts/ci/render-r2-explorer-wrangler-config.sh"
      - "scripts/ci/worker-share-smoke.sh"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (must be main for production)"
        required: true
        default: "main"

permissions:
  contents: read
  deployments: write

jobs:
  deploy-preview:
    name: Deploy preview
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    environment: preview
    concurrency:
      group: r2-explorer-preview-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      R2E_FILES_BUCKET: ${{ vars.R2E_FILES_BUCKET }}
      R2E_FILES_BUCKET_PREVIEW: ${{ vars.R2E_FILES_BUCKET_PREVIEW }}
      R2E_SHARES_KV_ID: ${{ vars.R2E_SHARES_KV_ID }}
      R2E_SHARES_KV_ID_PREVIEW: ${{ vars.R2E_SHARES_KV_ID_PREVIEW }}
      R2E_KEYS_KV_ID: ${{ vars.R2E_KEYS_KV_ID }}
      R2E_KEYS_KV_ID_PREVIEW: ${{ vars.R2E_KEYS_KV_ID_PREVIEW }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Render Wrangler config
        run: ./scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: r2-explorer/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        working-directory: r2-explorer
        run: pnpm run check

      - name: Test
        working-directory: r2-explorer
        run: pnpm test

      - name: Deploy preview
        working-directory: r2-explorer
        run: pnpm exec wrangler deploy --config wrangler.ci.toml --env preview

  smoke-preview:
    name: Smoke preview
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    needs: [deploy-preview]
    environment: preview
    env:
      R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
      R2E_SMOKE_ADMIN_KID: ${{ secrets.R2E_SMOKE_ADMIN_KID }}
      R2E_SMOKE_ADMIN_SECRET: ${{ secrets.R2E_SMOKE_ADMIN_SECRET }}
      R2E_SMOKE_BUCKET: ${{ secrets.R2E_SMOKE_BUCKET }}
      R2E_SMOKE_KEY: ${{ secrets.R2E_SMOKE_KEY }}
      R2E_SMOKE_RETRIES: "1"
      R2E_SMOKE_RETRY_DELAY_SEC: "2"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false
            extra-substituters = https://nix-r2-cloudflare-flake.cachix.org https://wrangler.cachix.org
            extra-trusted-public-keys = nix-r2-cloudflare-flake.cachix.org-1:pmYucG85iBm6Y+8TxNwqU5j/lmY1UBReZxIXslMFntw= wrangler.cachix.org-1:N/FIcG2qBQcolSpklb2IMDbsfjZKWg+ctxx0mSMXdSs=

      - name: Build r2 CLI
        run: nix --accept-flake-config build .#r2

      - name: Run Worker smoke checks
        env:
          R2E_SMOKE_R2_BIN: ./result/bin/r2
        run: |
          set -euo pipefail
          ./scripts/ci/worker-share-smoke.sh 2>&1 | tee smoke-preview.log

      - name: Upload smoke logs (preview)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-preview-logs
          path: smoke-preview.log
          if-no-files-found: ignore

  rollback-guidance-preview:
    name: Rollback guidance (preview)
    if: failure() && needs.smoke-preview.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy-preview, smoke-preview]
    steps:
      - name: Resolve rollback target
        id: rollback_target
        env:
          GH_TOKEN: ${{ github.token }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          set -euo pipefail

          deployments_json="$(gh api "repos/${GITHUB_REPOSITORY}/deployments?environment=preview&per_page=50")"
          candidate="$(
            printf '%s' "${deployments_json}" |
              jq -r --arg current "${GITHUB_SHA}" --arg ref "${GITHUB_HEAD_REF}" \
                '.[] | select(.sha != $current and .ref == $ref) | .sha' |
              head -n1
          )"

          if [[ -z "${candidate}" ]]; then
            candidate="${PR_BASE_SHA}"
          fi
          if [[ -z "${candidate}" ]]; then
            candidate="<last-known-good-ref>"
          fi

          echo "sha=${candidate}" >> "${GITHUB_OUTPUT}"

      - name: Publish rollback guidance
        run: |
          set -euo pipefail

          rollback_sha="${{ steps.rollback_target.outputs.sha }}"
          runbook_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_SHA}/docs/operators/rollback-worker-share.md"
          rollback_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${rollback_sha}"
          {
            echo "## Preview smoke checks failed"
            echo
            echo "Follow the Worker rollback runbook immediately:"
            echo "- ${runbook_url}"
            echo "- Candidate rollback SHA: \`${rollback_sha}\`"
            echo "- Candidate rollback tree: ${rollback_url}"
            echo "- Smoke logs artifact: \`smoke-preview-logs\`"
            echo
            echo "Required operator actions:"
            echo "1. Identify the last known-good Worker revision and matching env snapshot."
            echo "2. Redeploy the rollback target and reapply Access policy split."
            echo "3. Re-run share lifecycle and API protection checks."
            echo
            echo "Command checklist:"
            echo '```bash'
            echo 'git fetch origin'
            echo "git checkout ${rollback_sha}"
            echo './scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml'
            echo 'cd r2-explorer'
            echo 'pnpm install --frozen-lockfile'
            echo 'pnpm exec wrangler deploy --config wrangler.ci.toml --env preview'
            echo '```'
          } >> "${GITHUB_STEP_SUMMARY}"

  deploy-production:
    name: Deploy production
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: r2-explorer-production
      cancel-in-progress: false
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      R2E_FILES_BUCKET: ${{ vars.R2E_FILES_BUCKET }}
      R2E_FILES_BUCKET_PREVIEW: ${{ vars.R2E_FILES_BUCKET_PREVIEW }}
      R2E_SHARES_KV_ID: ${{ vars.R2E_SHARES_KV_ID }}
      R2E_SHARES_KV_ID_PREVIEW: ${{ vars.R2E_SHARES_KV_ID_PREVIEW }}
      R2E_KEYS_KV_ID: ${{ vars.R2E_KEYS_KV_ID }}
      R2E_KEYS_KV_ID_PREVIEW: ${{ vars.R2E_KEYS_KV_ID_PREVIEW }}
    steps:
      - name: Reject non-main production deploy ref
        run: |
          if [[ "${{ github.event.inputs.ref }}" != "main" ]]; then
            echo "Production deploys require ref=main." >&2
            echo "Got '${{ github.event.inputs.ref }}'." >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Render Wrangler config
        run: ./scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: r2-explorer/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        working-directory: r2-explorer
        run: pnpm run check

      - name: Test
        working-directory: r2-explorer
        run: pnpm test

      - name: Deploy production
        working-directory: r2-explorer
        run: pnpm exec wrangler deploy --config wrangler.ci.toml --env ""

  smoke-production:
    name: Smoke production
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [deploy-production]
    environment: production
    env:
      R2E_SMOKE_BASE_URL: ${{ secrets.R2E_SMOKE_BASE_URL }}
      R2E_SMOKE_ADMIN_KID: ${{ secrets.R2E_SMOKE_ADMIN_KID }}
      R2E_SMOKE_ADMIN_SECRET: ${{ secrets.R2E_SMOKE_ADMIN_SECRET }}
      R2E_SMOKE_BUCKET: ${{ secrets.R2E_SMOKE_BUCKET }}
      R2E_SMOKE_KEY: ${{ secrets.R2E_SMOKE_KEY }}
      R2E_SMOKE_RETRIES: "2"
      R2E_SMOKE_RETRY_DELAY_SEC: "3"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false
            extra-substituters = https://nix-r2-cloudflare-flake.cachix.org https://wrangler.cachix.org
            extra-trusted-public-keys = nix-r2-cloudflare-flake.cachix.org-1:pmYucG85iBm6Y+8TxNwqU5j/lmY1UBReZxIXslMFntw= wrangler.cachix.org-1:N/FIcG2qBQcolSpklb2IMDbsfjZKWg+ctxx0mSMXdSs=

      - name: Build r2 CLI
        run: nix --accept-flake-config build .#r2

      - name: Run Worker smoke checks
        env:
          R2E_SMOKE_R2_BIN: ./result/bin/r2
        run: |
          set -euo pipefail
          ./scripts/ci/worker-share-smoke.sh 2>&1 | tee smoke-production.log

      - name: Upload smoke logs (production)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-production-logs
          path: smoke-production.log
          if-no-files-found: ignore

  rollback-guidance-production:
    name: Rollback guidance (production)
    if: failure() && needs.smoke-production.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy-production, smoke-production]
    steps:
      - name: Resolve rollback target
        id: rollback_target
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          deployments_json="$(gh api "repos/${GITHUB_REPOSITORY}/deployments?environment=production&per_page=50")"
          candidate="$(
            printf '%s' "${deployments_json}" |
              jq -r --arg current "${GITHUB_SHA}" \
                '.[] | select(.sha != $current) | .sha' |
              head -n1
          )"

          if [[ -z "${candidate}" ]]; then
            candidate="<last-known-good-ref>"
          fi

          echo "sha=${candidate}" >> "${GITHUB_OUTPUT}"

      - name: Publish rollback guidance
        run: |
          set -euo pipefail

          rollback_sha="${{ steps.rollback_target.outputs.sha }}"
          runbook_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_SHA}/docs/operators/rollback-worker-share.md"
          rollback_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${rollback_sha}"
          {
            echo "## Production smoke checks failed"
            echo
            echo "Immediate rollback path:"
            echo "- ${runbook_url}"
            echo "- Candidate rollback SHA: \`${rollback_sha}\`"
            echo "- Candidate rollback tree: ${rollback_url}"
            echo "- Smoke logs artifact: \`smoke-production-logs\`"
            echo
            echo "Required operator actions:"
            echo "1. Roll back to the last known-good Worker revision."
            echo "2. Restore matching environment variables and Access policy split."
            echo "3. Verify /share token behavior and /api Access protection before leaving incident mode."
            echo
            echo "Command checklist:"
            echo '```bash'
            echo 'git fetch origin'
            echo "git checkout ${rollback_sha}"
            echo './scripts/ci/render-r2-explorer-wrangler-config.sh r2-explorer/wrangler.ci.toml'
            echo 'cd r2-explorer'
            echo 'pnpm install --frozen-lockfile'
            echo 'pnpm exec wrangler deploy --config wrangler.ci.toml --env ""'
            echo '```'
          } >> "${GITHUB_STEP_SUMMARY}"
