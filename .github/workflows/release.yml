name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Semver version without leading v (example: 1.2.3)"
        required: true
        type: string
      target_ref:
        description: "Git ref to release from (must resolve to main)"
        required: true
        default: "main"
        type: string
      prerelease:
        description: "Mark this release as a prerelease"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write

concurrency:
  group: release-production
  cancel-in-progress: false

env:
  RELEASE_VERSION: ${{ inputs.version }}
  RELEASE_TAG: v${{ inputs.version }}

jobs:
  preflight:
    name: release-preflight
    runs-on: ubuntu-latest
    outputs:
      release_date: ${{ steps.meta.outputs.release_date }}
    steps:
      - name: Validate release inputs
        env:
          TARGET_REF: ${{ inputs.target_ref }}
        run: |
          set -euo pipefail

          if [[ ! "${RELEASE_VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must be strict semver (X.Y.Z) without a leading 'v'." >&2
            exit 1
          fi

          if [[ "${TARGET_REF}" != "main" && "${TARGET_REF}" != "refs/heads/main" ]]; then
            echo "Releases are restricted to main. Got target_ref='${TARGET_REF}'." >&2
            exit 1
          fi

      - name: Checkout target ref
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_ref }}
          fetch-depth: 0

      - name: Verify ref resolves to origin/main and tag is unused
        run: |
          set -euo pipefail

          target_sha="$(git rev-parse HEAD)"
          main_sha="$(git rev-parse origin/main)"

          if [[ "${target_sha}" != "${main_sha}" ]]; then
            echo "Target ref does not resolve to origin/main." >&2
            echo "target_sha=${target_sha}" >&2
            echo "main_sha=${main_sha}" >&2
            exit 1
          fi

          if git ls-remote --exit-code --tags origin "refs/tags/${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Tag already exists on origin: ${RELEASE_TAG}" >&2
            exit 1
          fi

      - name: Capture release metadata
        id: meta
        run: |
          set -euo pipefail
          echo "release_date=$(date -u +%Y-%m-%d)" >> "${GITHUB_OUTPUT}"

  build-root:
    name: build-root-artifacts
    runs-on: ubuntu-latest
    needs: [preflight]
    steps:
      - name: Checkout target ref
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_ref }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false
            extra-substituters = https://nix-r2-cloudflare-flake.cachix.org https://wrangler.cachix.org
            extra-trusted-public-keys = nix-r2-cloudflare-flake.cachix.org-1:pmYucG85iBm6Y+8TxNwqU5j/lmY1UBReZxIXslMFntw= wrangler.cachix.org-1:N/FIcG2qBQcolSpklb2IMDbsfjZKWg+ctxx0mSMXdSs=

      - name: Configure Cachix
        uses: cachix/cachix-action@v16
        with:
          name: nix-r2-cloudflare-flake
          extraPullNames: wrangler
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          skipPush: true

      - name: Build root CLI package
        run: |
          set -euo pipefail
          nix build .#r2

      - name: Package root release artifacts
        run: |
          set -euo pipefail

          mkdir -p artifacts/root
          out_path="$(nix path-info .#r2)"
          system="$(nix eval --raw --expr builtins.currentSystem)"

          if [[ ! -d "${out_path}" ]]; then
            echo "Expected Nix output path does not exist: ${out_path}" >&2
            exit 1
          fi

          nix path-info .#r2 > artifacts/root/path-info.txt
          nix path-info -S .#r2 > artifacts/root/path-info-size.txt
          echo "${system}" > artifacts/root/system.txt
          nix-store --query --requisites "${out_path}" > artifacts/root/closure-paths.txt

          tar -czf "artifacts/root/r2-${RELEASE_TAG}-${system}.tar.gz" -C "${out_path}" .

      - name: Upload root release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: root-release-artifacts
          path: artifacts/root/*
          if-no-files-found: error

  build-worker:
    name: build-worker-artifacts
    runs-on: ubuntu-latest
    needs: [preflight]
    steps:
      - name: Checkout target ref
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: r2-explorer/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        working-directory: r2-explorer
        run: pnpm run check

      - name: Test
        id: worker-tests
        working-directory: r2-explorer
        run: |
          set -euo pipefail
          mkdir -p test-results
          pnpm test 2>&1 | tee test-results/vitest.log

      - name: Upload worker test results (on failure)
        if: ${{ failure() && steps.worker-tests.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: worker-test-results
          path: r2-explorer/test-results/
          if-no-files-found: ignore

      - name: Package worker release artifacts
        run: |
          set -euo pipefail

          mkdir -p artifacts/worker

          node --version > artifacts/worker/node-version.txt
          pnpm --version > artifacts/worker/pnpm-version.txt
          (
            cd r2-explorer
            pnpm exec wrangler --version
          ) > artifacts/worker/wrangler-version.txt

          tar -czf "artifacts/worker/r2-explorer-${RELEASE_TAG}.tar.gz" \
            r2-explorer/src \
            r2-explorer/package.json \
            r2-explorer/pnpm-lock.yaml \
            r2-explorer/tsconfig.json \
            r2-explorer/vitest.config.ts \
            r2-explorer/wrangler.toml

      - name: Upload worker release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: worker-release-artifacts
          path: artifacts/worker/*
          if-no-files-found: error

  publish-release:
    name: publish-release
    runs-on: ubuntu-latest
    needs: [preflight, build-root, build-worker]
    steps:
      - name: Checkout target ref
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_ref }}
          fetch-depth: 0

      - name: Download root artifacts
        uses: actions/download-artifact@v4
        with:
          name: root-release-artifacts
          path: release-artifacts/root

      - name: Download worker artifacts
        uses: actions/download-artifact@v4
        with:
          name: worker-release-artifacts
          path: release-artifacts/worker

      - name: Prepare changelog and release notes
        env:
          RELEASE_DATE: ${{ needs.preflight.outputs.release_date }}
        run: |
          set -euo pipefail

          ./scripts/release/prepare-changelog.sh \
            --version "${RELEASE_VERSION}" \
            --date "${RELEASE_DATE}"

          ./scripts/release/generate-release-notes.sh \
            --version "${RELEASE_VERSION}" \
            > RELEASE_NOTES.md

      - name: Commit changelog and create tag
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changelog changes were produced for ${RELEASE_TAG}." >&2
            exit 1
          fi

          git commit -m "chore(release): ${RELEASE_TAG}"
          git tag -a "${RELEASE_TAG}" -m "Release ${RELEASE_TAG}"

      - name: Push release commit and tag
        env:
          RELEASE_PUSH_TOKEN: ${{ secrets.RELEASE_PUSH_TOKEN }}
        run: |
          set -euo pipefail

          push_token="${RELEASE_PUSH_TOKEN}"
          if [[ -z "${push_token}" ]]; then
            push_token="${{ github.token }}"
          fi
          echo "::add-mask::${push_token}"

          git remote set-url origin "https://x-access-token:${push_token}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin HEAD:main
          git push origin "${RELEASE_TAG}"

      - name: Create GitHub release
        env:
          RELEASE_PUSH_TOKEN: ${{ secrets.RELEASE_PUSH_TOKEN }}
        run: |
          set -euo pipefail

          gh_token="${RELEASE_PUSH_TOKEN}"
          if [[ -z "${gh_token}" ]]; then
            gh_token="${{ github.token }}"
          fi
          echo "::add-mask::${gh_token}"
          export GH_TOKEN="${gh_token}"

          release_args=(
            "${RELEASE_TAG}"
            "--target"
            "${RELEASE_TAG}"
            "--title"
            "${RELEASE_TAG}"
            "--notes-file"
            "RELEASE_NOTES.md"
          )

          if [[ "${{ inputs.prerelease }}" == "true" ]]; then
            release_args+=("--prerelease")
          fi

          shopt -s nullglob
          assets=(release-artifacts/root/* release-artifacts/worker/*)
          shopt -u nullglob
          if [[ ${#assets[@]} -eq 0 ]]; then
            echo "No release assets found under release-artifacts/." >&2
            exit 1
          fi
          release_args+=("${assets[@]}")

          gh release create "${release_args[@]}"
