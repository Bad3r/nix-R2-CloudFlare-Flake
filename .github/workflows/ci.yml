name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  prepare-build:
    name: prepare-build
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    env:
      CI_STRICT: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false

      - name: Restore Nix cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Build root package once
        run: nix build .#r2

      - name: Record build output path
        run: nix path-info .#r2 > r2-out-path.txt

      - name: Upload build output metadata
        uses: actions/upload-artifact@v4
        with:
          name: prepare-build-output
          path: r2-out-path.txt
          retention-days: 1

      - name: Save Nix cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}

  validate-root-format-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CI_STRICT: "1"
    name: validate (root-format-lint)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false

      - name: Validate target
        run: ./scripts/ci/validate.sh --target root-format-lint

  validate-root-flake-template-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CI_STRICT: "1"
    name: validate (root-flake-template-docs)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false

      - name: Validate target
        run: ./scripts/ci/validate.sh --target root-flake-template-docs

  validate-root-cli-module-eval:
    needs: [prepare-build]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CI_STRICT: "1"
    name: validate (root-cli-module-eval)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false

      - name: Restore Nix cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Download prepare-build output metadata
        uses: actions/download-artifact@v4
        with:
          name: prepare-build-output

      - name: Verify prepared build output path exists
        run: |
          set -euo pipefail
          test -s r2-out-path.txt
          out_path="$(cat r2-out-path.txt)"
          nix path-info "$out_path" >/dev/null

      - name: Validate target
        run: ./scripts/ci/validate.sh --target root-cli-module-eval

      - name: Save Nix cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}

  validate-worker-typecheck-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CI_STRICT: "1"
    name: validate (worker-typecheck-test)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false

      - name: Restore Nix cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Validate target
        run: ./scripts/ci/validate.sh --target worker-typecheck-test

      - name: Save Nix cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}

  security-dependency-audit:
    needs: [prepare-build]
    name: security-dependency-audit
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: false
          extra-conf: |
            experimental-features = nix-command flakes
            require-sigs = false

      - name: Restore Nix cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: r2-explorer/pnpm-lock.yaml

      - name: Restore pnpm store cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('r2-explorer/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      - name: Download prepare-build output metadata
        uses: actions/download-artifact@v4
        with:
          name: prepare-build-output

      - name: Audit flake inputs (root + worker)
        run: |
          set -euo pipefail

          run_flake_checker() {
            local lock_path="$1"
            for attempt in 1 2 3; do
              if nix run nixpkgs#flake-checker -- \
                --no-telemetry \
                --fail-mode \
                --check-outdated \
                --check-owner \
                --check-supported \
                "$lock_path"; then
                return 0
              fi
              if [[ "$attempt" -lt 3 ]]; then
                echo "flake-checker attempt ${attempt} failed for ${lock_path}; retrying..." >&2
                sleep 5
              fi
            done
            return 1
          }

          run_flake_checker flake.lock
          run_flake_checker r2-explorer/flake.lock

      - name: Install Worker dependencies
        working-directory: r2-explorer
        run: pnpm install --frozen-lockfile

      - name: Audit Worker dependencies (high+critical)
        working-directory: r2-explorer
        run: pnpm audit --audit-level=high

      - name: Build root package for closure scan
        run: |
          set -euo pipefail
          test -s r2-out-path.txt
          out_path="$(cat r2-out-path.txt)"
          nix path-info "$out_path" >/dev/null

      - name: Scan Nix closure with vulnix
        run: |
          set -euo pipefail
          out_path="$(cat r2-out-path.txt)"
          for attempt in 1 2 3; do
            if nix run nixpkgs#vulnix -- -C "$out_path" -w ./scripts/ci/vulnix-whitelist.toml; then
              exit 0
            fi
            if [[ "$attempt" -lt 3 ]]; then
              echo "vulnix attempt ${attempt} failed; retrying..." >&2
              sleep 5
            fi
          done
          echo "vulnix scan failed after retries." >&2
          exit 1

      - name: Save pnpm store cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('r2-explorer/pnpm-lock.yaml') }}

      - name: Save Nix cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            /nix/var/nix/profiles
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock', 'r2-explorer/flake.lock') }}-${{ github.workflow }}

  security-sensitive-change-policy:
    name: security-sensitive-change-policy
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Detect sensitive changes
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const sensitivePatterns = [
              /^\.github\/workflows\/.*/,
              /(^|\/)flake\.lock$/,
              /(^|\/)pnpm-lock\.yaml$/
            ];

            if (context.eventName !== "pull_request") {
              core.info("Sensitive-change policy is enforced on pull_request events.");
              core.setOutput("sensitive_changed", "false");
              core.setOutput("matched_files", "");
              return;
            }

            const prNumber = context.payload.pull_request.number;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100
              }
            );

            const matched = files
              .map((f) => f.filename)
              .filter((filename) =>
                sensitivePatterns.some((pattern) => pattern.test(filename))
              );

            core.info(`Sensitive files changed: ${matched.length}`);
            core.setOutput("sensitive_changed", matched.length > 0 ? "true" : "false");
            core.setOutput("matched_files", matched.join("\n"));

      - name: Enforce security review label for sensitive changes
        if: github.event_name == 'pull_request' && steps.detect.outputs.sensitive_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const requiredLabel = "security-review-approved";
            const labels = (context.payload.pull_request.labels || []).map((label) => label.name);
            if (!labels.includes(requiredLabel)) {
              const changed = `${{ steps.detect.outputs.matched_files }}`;
              core.setFailed(
                [
                  `Sensitive file changes detected:\n${changed}`,
                  `Missing required label: ${requiredLabel}`,
                  "Add the label and ensure CODEOWNER approval before merge."
                ].join("\n\n")
              );
            }
